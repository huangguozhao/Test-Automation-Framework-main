# APIæµ‹è¯•æ¡†æ¶å¿«é€Ÿå‚è€ƒå¡ç‰‡

## ğŸš€ å¿«é€Ÿå‘½ä»¤

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest testcase/ --alluredir=report/temp -v

# è¿è¡ŒæŒ‡å®šæ¨¡å—
pytest testcase/YourModule/ --alluredir=report/temp -v

# å¹¶è¡Œè¿è¡Œ
pytest testcase/ -n 4 --alluredir=report/temp

# æŸ¥çœ‹æŠ¥å‘Š
allure serve report/temp

# ç”Ÿæˆé™æ€æŠ¥å‘Š
allure generate report/temp -o report/html --clean
```

## ğŸ“ YAMLæ¨¡æ¿

### åŸºç¡€GETè¯·æ±‚
```yaml
- baseInfo:
    api_name: è·å–æ•°æ®
    url: https://api.example.com/data
    method: GET
    header:
      Authorization: Bearer token
  testCase:
    - case_name: æ­£å¸¸è·å–
      validation:
        - eq: { '$.status_code': 200 }
        - contains: { '$.json().message': 'success' }
```

### POSTè¯·æ±‚
```yaml
- baseInfo:
    api_name: åˆ›å»ºæ•°æ®
    url: https://api.example.com/data
    method: POST
    header:
      Content-Type: application/json
  testCase:
    - case_name: åˆ›å»ºæˆåŠŸ
      json:
        name: "æµ‹è¯•"
        value: 123
      validation:
        - eq: { '$.status_code': 201 }
        - contains: { '$.json().name': 'æµ‹è¯•' }
```

## ğŸ¯ Pythonæµ‹è¯•æ–‡ä»¶æ¨¡æ¿

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-

import pytest
import allure
from common.readyaml import get_testcase_yaml
from common.sendrequest import SendRequest
from common.assertions import Assertions


@allure.epic("ç³»ç»Ÿåç§°")
@allure.feature("æ¨¡å—åç§°")
class TestYourModule:
    """æ¨¡å—æµ‹è¯•"""

    @pytest.mark.parametrize("case_data", get_testcase_yaml("testcase/YourModule/test_cases.yaml"))
    def test_api(self, case_data):
        # æ•°æ®ç»“æ„å¤„ç†
        if isinstance(case_data, list) and len(case_data) == 2:
            base_info = case_data[0]
            test_case = case_data[1]
        elif isinstance(case_data, dict) and 'baseInfo' in case_data:
            base_info = case_data['baseInfo']
            test_case = case_data['testCase'][0]
        else:
            pytest.fail(f"ä¸æ”¯æŒçš„æ•°æ®æ ¼å¼: {type(case_data)}")
        
        # AllureæŠ¥å‘Š
        allure.dynamic.story(base_info["api_name"])
        allure.dynamic.title(f"{base_info['api_name']} - {test_case['case_name']}")
        
        # å‘é€è¯·æ±‚
        send_request = SendRequest()
        response = send_request.send_request(
            method=base_info["method"],
            url=base_info["url"],
            headers=base_info.get("header", {}),
            json=test_case.get("json", {}),
            params=test_case.get("params", {}),
            data=test_case.get("data", {})
        )
        
        # æ·»åŠ æŠ¥å‘Šä¿¡æ¯
        with allure.step("è¯·æ±‚ä¿¡æ¯"):
            allure.attach(f"URL: {base_info['url']}", "è¯·æ±‚URL", allure.attachment_type.TEXT)
            allure.attach(f"Method: {base_info['method']}", "è¯·æ±‚æ–¹æ³•", allure.attachment_type.TEXT)
            if test_case.get("json"):
                allure.attach(str(test_case["json"]), "è¯·æ±‚ä½“", allure.attachment_type.JSON)
        
        with allure.step("å“åº”ä¿¡æ¯"):
            allure.attach(f"çŠ¶æ€ç : {response.status_code}", "å“åº”çŠ¶æ€ç ", allure.attachment_type.TEXT)
            allure.attach(response.text, "å“åº”å†…å®¹", allure.attachment_type.JSON)
        
        # æ‰§è¡Œæ–­è¨€
        assertions = Assertions()
        with allure.step("æ‰§è¡Œæ–­è¨€éªŒè¯"):
            for validation in test_case.get("validation", []):
                assertions.assert_response_any(response, validation)
```

## âœ… å¸¸ç”¨æ–­è¨€

```yaml
validation:
  # çŠ¶æ€ç æ–­è¨€
  - eq: { '$.status_code': 200 }
  - ne: { '$.status_code': 500 }
  
  # JSONå­—æ®µæ–­è¨€
  - eq: { '$.json().code': 200 }
  - contains: { '$.json().message': 'æˆåŠŸ' }
  - ne: { '$.json().error': null }
  
  # æ•°ç»„æ–­è¨€
  - eq: { '$.json()[0].id': 1 }
  - gt: { '$.json().length': 0 }
  
  # åµŒå¥—å¯¹è±¡
  - eq: { '$.json().data.user.name': 'admin' }
  - contains: { '$.json().data.list[0].title': 'æµ‹è¯•' }
```

## ğŸ”§ JSONPathé€ŸæŸ¥

```bash
$.status_code           # HTTPçŠ¶æ€ç 
$.text                  # å“åº”æ–‡æœ¬
$.json()               # æ•´ä¸ªJSON
$.json().field         # å­—æ®µå€¼
$.json()[0]            # æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ 
$.json()[0].field      # æ•°ç»„å…ƒç´ å­—æ®µ
$.json().data.user     # åµŒå¥—å¯¹è±¡
$.json().list[*].name  # æ‰€æœ‰å…ƒç´ çš„nameå­—æ®µ
```

## ğŸ“ ç›®å½•ç»“æ„åˆ›å»º

```bash
# åˆ›å»ºæ–°æµ‹è¯•æ¨¡å—
mkdir testcase/YourSystem
touch testcase/YourSystem/__init__.py
touch testcase/YourSystem/test_api.py
touch testcase/YourSystem/api_cases.yaml
```

## ğŸ› è°ƒè¯•æŠ€å·§

```python
# æ‰“å°å“åº”å†…å®¹
print(f"çŠ¶æ€ç : {response.status_code}")
print(f"å“åº”å¤´: {response.headers}")
print(f"å“åº”ä½“: {response.text}")

# è°ƒè¯•JSONPath
import jsonpath
result = jsonpath.jsonpath(response.json(), '$.data.users[0].name')
print(f"JSONPathç»“æœ: {result}")

# æ·»åŠ è°ƒè¯•æ–­ç‚¹
import pdb; pdb.set_trace()
```

## ğŸ¨ Allureæ ‡è®°

```python
@allure.epic("ç”µå•†ç³»ç»Ÿ")                    # é¡¹ç›®çº§åˆ«
@allure.feature("ç”¨æˆ·ç®¡ç†")                 # åŠŸèƒ½çº§åˆ«  
@allure.story("ç”¨æˆ·æ³¨å†Œ")                   # ç”¨æˆ·æ•…äº‹
@allure.severity(allure.severity_level.CRITICAL)  # ä¸¥é‡ç¨‹åº¦
@allure.tag("smoke", "regression")          # æ ‡ç­¾
@allure.link("http://example.com")          # é“¾æ¥
@allure.issue("BUG-123")                   # ç¼ºé™·é“¾æ¥
@allure.testcase("TC-456")                 # æµ‹è¯•ç”¨ä¾‹é“¾æ¥
```

## ğŸ”„ å¸¸è§æ“ä½œ

### ç¯å¢ƒåˆ‡æ¢
```python
# åœ¨conftest.pyä¸­
@pytest.fixture(scope="session")
def base_url():
    env = os.getenv("TEST_ENV", "test")
    urls = {
        "test": "https://test-api.example.com",
        "prod": "https://api.example.com"
    }
    return urls[env]
```

### æ•°æ®æå–
```yaml
# æå–token
extract:
  token: $.json().token
  user_id: $.json().data.id

# ä½¿ç”¨æå–çš„æ•°æ®
header:
  Authorization: Bearer ${token}
```

### å¤±è´¥é‡è¯•
```bash
pip install pytest-rerunfailures
pytest testcase/ --reruns 2 --reruns-delay 1
```

## ğŸ“Š æŠ¥å‘Šå®šåˆ¶

### ç¯å¢ƒä¿¡æ¯
```properties
# report/allure-results/environment.properties
Environment=Test
API.Version=v1.0
Base.URL=https://test-api.example.com
```

### åˆ†ç±»é…ç½®
```json
// report/allure-results/categories.json
[
  {
    "name": "æ¥å£é”™è¯¯",
    "matchedStatuses": ["failed"],
    "messageRegex": ".*ConnectionError.*"
  }
]
```

---

**ä¿å­˜æ­¤å¡ç‰‡ä»¥ä¾¿å¿«é€ŸæŸ¥é˜…ï¼** ğŸ“Œ